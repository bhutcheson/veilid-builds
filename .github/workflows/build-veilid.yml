# .github/workflows/build-veilid.yml
#
# Build Veilid binaries from GitLab source for Kunuleco distribution.
#
# Veilid (gitlab.com/veilid/veilid) doesn't provide official binaries.
# This workflow builds from source and publishes to GitHub Releases.
#
# Usage:
#   1. Manual trigger: Actions → Build Veilid → Run workflow
#   2. Auto-trigger: Push a tag like "veilid-v0.5.2"
#
# Updated for Veilid 0.5.2:
#   - MSRV is now 1.88.0
#   - Cap'n Proto 1.1.0
#   - Logging system overhauled

name: Build Veilid Binaries

on:
  workflow_dispatch:
    inputs:
      veilid_ref:
        description: 'Veilid git ref to build (tag like v0.5.2, branch, or commit)'
        required: true
        default: 'v0.5.2'
        type: string
      release_tag:
        description: 'Tag for your release (e.g., veilid-0.5.2-kunuleco.1)'
        required: true
        type: string
      prerelease:
        description: 'Mark as prerelease'
        required: false
        default: false
        type: boolean
        
  push:
    tags:
      - 'veilid-v*'

env:
  CARGO_TERM_COLOR: always
  # CRITICAL: Veilid 0.5.2 requires Rust 1.88.0 minimum
  RUST_VERSION: '1.88.0'
  VEILID_GITLAB_URL: 'https://gitlab.com/veilid/veilid.git'
  # Cap'n Proto version required
  CAPNP_VERSION: '1.1.0'

jobs:
  # ============================================================
  # Linux x64 Build
  # ============================================================
  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-22.04
    
    steps:
      - name: Clone Veilid from GitLab
        run: |
          git clone ${{ env.VEILID_GITLAB_URL }} veilid
          cd veilid
          git checkout ${{ inputs.veilid_ref || github.ref_name }}
          echo "VEILID_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "VEILID_COMMIT_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "Checked out: $(git rev-parse HEAD)"
          
      - name: Get Veilid version
        id: version
        working-directory: veilid
        run: |
          VERSION=$(grep '^version' veilid-server/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building Veilid version ${VERSION}"
          
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            veilid/target
          key: linux-x64-cargo-${{ hashFiles('veilid/**/Cargo.lock') }}
          restore-keys: |
            linux-x64-cargo-
            
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            pkg-config \
            libdbus-1-dev \
            protobuf-compiler \
            libprotobuf-dev
            
      - name: Install Cap'n Proto ${{ env.CAPNP_VERSION }}
        run: |
          curl -O https://capnproto.org/capnproto-c++-${{ env.CAPNP_VERSION }}.tar.gz
          tar zxf capnproto-c++-${{ env.CAPNP_VERSION }}.tar.gz
          cd capnproto-c++-${{ env.CAPNP_VERSION }}
          ./configure
          make -j$(nproc)
          sudo make install
          sudo ldconfig
          capnp --version
          
      - name: Build veilid-server (release)
        working-directory: veilid/veilid-server
        run: cargo build --release
          
      - name: Build veilid-cli (release)
        working-directory: veilid/veilid-cli
        run: cargo build --release
          
      - name: Package binaries
        run: |
          mkdir -p dist/veilid-linux-x64
          cp veilid/target/release/veilid-server dist/veilid-linux-x64/
          cp veilid/target/release/veilid-cli dist/veilid-linux-x64/
          
          # Create build info
          cat > dist/veilid-linux-x64/BUILD_INFO.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "veilid_ref": "${{ inputs.veilid_ref || github.ref_name }}",
            "commit": "${{ env.VEILID_COMMIT }}",
            "commit_short": "${{ env.VEILID_COMMIT_SHORT }}",
            "rust_version": "${{ env.RUST_VERSION }}",
            "platform": "linux-x64",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "https://gitlab.com/veilid/veilid"
          }
          EOF
          
          cd dist
          tar -czvf veilid-linux-x64.tar.gz veilid-linux-x64/
          sha256sum veilid-linux-x64.tar.gz > veilid-linux-x64.tar.gz.sha256
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: veilid-linux-x64
          path: |
            dist/veilid-linux-x64.tar.gz
            dist/veilid-linux-x64.tar.gz.sha256

  # ============================================================
  # Windows x64 Build
  # ============================================================
  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest
    
    steps:
      - name: Clone Veilid from GitLab
        run: |
          git clone ${{ env.VEILID_GITLAB_URL }} veilid
          cd veilid
          git checkout ${{ inputs.veilid_ref || github.ref_name }}
          echo "VEILID_COMMIT=$(git rev-parse HEAD)" >> $env:GITHUB_ENV
          echo "VEILID_COMMIT_SHORT=$(git rev-parse --short HEAD)" >> $env:GITHUB_ENV
          
      - name: Get Veilid version
        id: version
        working-directory: veilid
        shell: bash
        run: |
          VERSION=$(grep '^version' veilid-server/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            veilid/target
          key: windows-x64-cargo-${{ hashFiles('veilid/**/Cargo.lock') }}
          restore-keys: |
            windows-x64-cargo-
            
      - name: Install Protobuf
        run: choco install protoc -y
        
      - name: Install Cap'n Proto
        run: |
          choco install capnproto -y
          capnp --version
          
      - name: Build veilid-server (release)
        working-directory: veilid/veilid-server
        run: cargo build --release
          
      - name: Build veilid-cli (release)
        working-directory: veilid/veilid-cli
        run: cargo build --release
          
      - name: Package binaries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "dist\veilid-windows-x64"
          Copy-Item "veilid\target\release\veilid-server.exe" "dist\veilid-windows-x64\"
          Copy-Item "veilid\target\release\veilid-cli.exe" "dist\veilid-windows-x64\"
          
          # Create build info
          $buildInfo = @{
            version = "${{ steps.version.outputs.version }}"
            veilid_ref = "${{ inputs.veilid_ref || github.ref_name }}"
            commit = "${{ env.VEILID_COMMIT }}"
            commit_short = "${{ env.VEILID_COMMIT_SHORT }}"
            rust_version = "${{ env.RUST_VERSION }}"
            platform = "windows-x64"
            build_date = (Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ")
            source = "https://gitlab.com/veilid/veilid"
          } | ConvertTo-Json
          $buildInfo | Out-File -FilePath "dist\veilid-windows-x64\BUILD_INFO.json" -Encoding utf8
          
          Compress-Archive -Path "dist\veilid-windows-x64" -DestinationPath "dist\veilid-windows-x64.zip"
          
          $hash = (Get-FileHash "dist\veilid-windows-x64.zip" -Algorithm SHA256).Hash.ToLower()
          "$hash  veilid-windows-x64.zip" | Out-File -FilePath "dist\veilid-windows-x64.zip.sha256" -Encoding utf8
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: veilid-windows-x64
          path: |
            dist/veilid-windows-x64.zip
            dist/veilid-windows-x64.zip.sha256

  # ============================================================
  # macOS Intel Build (Experimental)
  # ============================================================
  build-macos-x64:
    name: Build macOS Intel (Experimental)
    runs-on: macos-15-intel
    
    steps:
      - name: Clone Veilid from GitLab
        run: |
          git clone ${{ env.VEILID_GITLAB_URL }} veilid
          cd veilid
          git checkout ${{ inputs.veilid_ref || github.ref_name }}
          echo "VEILID_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "VEILID_COMMIT_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          
      - name: Get Veilid version
        id: version
        working-directory: veilid
        run: |
          VERSION=$(grep '^version' veilid-server/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            veilid/target
          key: macos-x64-cargo-${{ hashFiles('veilid/**/Cargo.lock') }}
          restore-keys: |
            macos-x64-cargo-
            
      - name: Install dependencies
        run: |
          brew install protobuf capnp
          capnp --version
          
      - name: Build veilid-server (release)
        working-directory: veilid/veilid-server
        run: cargo build --release
          
      - name: Build veilid-cli (release)
        working-directory: veilid/veilid-cli
        run: cargo build --release
          
      - name: Package binaries
        run: |
          mkdir -p dist/veilid-macos-x64
          cp veilid/target/release/veilid-server dist/veilid-macos-x64/
          cp veilid/target/release/veilid-cli dist/veilid-macos-x64/
          
          cat > dist/veilid-macos-x64/BUILD_INFO.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "veilid_ref": "${{ inputs.veilid_ref || github.ref_name }}",
            "commit": "${{ env.VEILID_COMMIT }}",
            "commit_short": "${{ env.VEILID_COMMIT_SHORT }}",
            "rust_version": "${{ env.RUST_VERSION }}",
            "platform": "macos-x64",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "https://gitlab.com/veilid/veilid",
            "experimental": true
          }
          EOF
          
          cd dist
          tar -czvf veilid-macos-x64.tar.gz veilid-macos-x64/
          shasum -a 256 veilid-macos-x64.tar.gz > veilid-macos-x64.tar.gz.sha256
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: veilid-macos-x64
          path: |
            dist/veilid-macos-x64.tar.gz
            dist/veilid-macos-x64.tar.gz.sha256

  # ============================================================
  # macOS ARM64 Build (Experimental)
  # ============================================================
  build-macos-arm64:
    name: Build macOS ARM64 (Experimental)
    runs-on: macos-14
    
    steps:
      - name: Clone Veilid from GitLab
        run: |
          git clone ${{ env.VEILID_GITLAB_URL }} veilid
          cd veilid
          git checkout ${{ inputs.veilid_ref || github.ref_name }}
          echo "VEILID_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "VEILID_COMMIT_SHORT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          
      - name: Get Veilid version
        id: version
        working-directory: veilid
        run: |
          VERSION=$(grep '^version' veilid-server/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          
      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            veilid/target
          key: macos-arm64-cargo-${{ hashFiles('veilid/**/Cargo.lock') }}
          restore-keys: |
            macos-arm64-cargo-
            
      - name: Install dependencies
        run: |
          brew install protobuf capnp
          capnp --version
          
      - name: Build veilid-server (release)
        working-directory: veilid/veilid-server
        run: cargo build --release
          
      - name: Build veilid-cli (release)
        working-directory: veilid/veilid-cli
        run: cargo build --release
          
      - name: Package binaries
        run: |
          mkdir -p dist/veilid-macos-arm64
          cp veilid/target/release/veilid-server dist/veilid-macos-arm64/
          cp veilid/target/release/veilid-cli dist/veilid-macos-arm64/
          
          cat > dist/veilid-macos-arm64/BUILD_INFO.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "veilid_ref": "${{ inputs.veilid_ref || github.ref_name }}",
            "commit": "${{ env.VEILID_COMMIT }}",
            "commit_short": "${{ env.VEILID_COMMIT_SHORT }}",
            "rust_version": "${{ env.RUST_VERSION }}",
            "platform": "macos-arm64",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "source": "https://gitlab.com/veilid/veilid",
            "experimental": true
          }
          EOF
          
          cd dist
          tar -czvf veilid-macos-arm64.tar.gz veilid-macos-arm64/
          shasum -a 256 veilid-macos-arm64.tar.gz > veilid-macos-arm64.tar.gz.sha256
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: veilid-macos-arm64
          path: |
            dist/veilid-macos-arm64.tar.gz
            dist/veilid-macos-arm64.tar.gz.sha256

  # ============================================================
  # Create Release
  # ============================================================
  create-release:
    name: Create Release
    needs: [build-linux-x64, build-windows-x64, build-macos-x64, build-macos-arm64]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Move all artifacts to release folder
          cp artifacts/veilid-linux-x64/* release/
          cp artifacts/veilid-windows-x64/* release/
          cp artifacts/veilid-macos-x64/* release/
          cp artifacts/veilid-macos-arm64/* release/
          
          # Create combined manifest fragment for installer
          cd release
          cat > manifest-fragment.json << 'EOF'
          {
            "component": "veilid",
            "version": "${{ inputs.veilid_ref || github.ref_name }}",
            "release_tag": "${{ inputs.release_tag || github.ref_name }}",
            "binaries": {
              "linux-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag || github.ref_name }}/veilid-linux-x64.tar.gz",
                "sha256": "LINUX_SHA256",
                "archive_type": "tar.gz",
                "executables": ["veilid-server", "veilid-cli"]
              },
              "windows-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag || github.ref_name }}/veilid-windows-x64.zip",
                "sha256": "WINDOWS_SHA256",
                "archive_type": "zip",
                "executables": ["veilid-server.exe", "veilid-cli.exe"]
              },
              "macos-x64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag || github.ref_name }}/veilid-macos-x64.tar.gz",
                "sha256": "MACOS_X64_SHA256",
                "archive_type": "tar.gz",
                "executables": ["veilid-server", "veilid-cli"],
                "experimental": true
              },
              "macos-arm64": {
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ inputs.release_tag || github.ref_name }}/veilid-macos-arm64.tar.gz",
                "sha256": "MACOS_ARM64_SHA256",
                "archive_type": "tar.gz",
                "executables": ["veilid-server", "veilid-cli"],
                "experimental": true
              }
            }
          }
          EOF
          
          # Replace SHA256 placeholders with actual values
          LINUX_SHA=$(cat veilid-linux-x64.tar.gz.sha256 | awk '{print $1}')
          WINDOWS_SHA=$(cat veilid-windows-x64.zip.sha256 | awk '{print $1}')
          MACOS_X64_SHA=$(cat veilid-macos-x64.tar.gz.sha256 | awk '{print $1}')
          MACOS_ARM64_SHA=$(cat veilid-macos-arm64.tar.gz.sha256 | awk '{print $1}')
          
          sed -i "s/LINUX_SHA256/$LINUX_SHA/g" manifest-fragment.json
          sed -i "s/WINDOWS_SHA256/$WINDOWS_SHA/g" manifest-fragment.json
          sed -i "s/MACOS_X64_SHA256/$MACOS_X64_SHA/g" manifest-fragment.json
          sed -i "s/MACOS_ARM64_SHA256/$MACOS_ARM64_SHA/g" manifest-fragment.json
          
          echo "=== Manifest Fragment ==="
          cat manifest-fragment.json
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag || github.ref_name }}
          name: "Veilid ${{ inputs.veilid_ref || github.ref_name }} for Kunuleco"
          prerelease: ${{ inputs.prerelease || false }}
          body: |
            ## Veilid Binaries for Kunuleco
            
            Built from Veilid source: `${{ inputs.veilid_ref || github.ref_name }}`
            Source: https://gitlab.com/veilid/veilid
            
            ### Platforms
            | Platform | Status | File |
            |----------|--------|------|
            | Linux x64 | ✅ Supported | `veilid-linux-x64.tar.gz` |
            | Windows x64 | ✅ Supported | `veilid-windows-x64.zip` |
            | macOS Intel | ⚠️ Experimental | `veilid-macos-x64.tar.gz` |
            | macOS ARM64 | ⚠️ Experimental | `veilid-macos-arm64.tar.gz` |
            
            ### Build Info
            - Rust Version: ${{ env.RUST_VERSION }}
            - Cap'n Proto: ${{ env.CAPNP_VERSION }}
            
            ### For Kunuleco Installer
            Download `manifest-fragment.json` and merge into your installer manifest.
            
          files: |
            release/veilid-linux-x64.tar.gz
            release/veilid-linux-x64.tar.gz.sha256
            release/veilid-windows-x64.zip
            release/veilid-windows-x64.zip.sha256
            release/veilid-macos-x64.tar.gz
            release/veilid-macos-x64.tar.gz.sha256
            release/veilid-macos-arm64.tar.gz
            release/veilid-macos-arm64.tar.gz.sha256
            release/manifest-fragment.json
